---
title: "Functional differences between wild mice microbiome and SPF in ASO mice"
subtitle: "Data: HUMAnN 3.9 unstratified pathways"
author: "Daniel Dumitrescu, Giacomo Antonello, Nicola Segata, Levi Waldron, Sarkis Mazmanian"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    self_contained: true
    toc_depth: 3
    code_folding: hide
    toc_float: true
    number_sections: true
    thumbnails: false
    lightbox: true
    gallery: false
    use_bookdown: true
    highlight: haddock
params:
  basic_outdir: "results"
  microbiome_basic_transform: "gene_family_abundance_rpk_relab_unstratified"
  humann_data_type: "pathways"
  beta_dist: "bray"
  beta_MDS: "MDS"
---

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r, include=FALSE}
# packages for tabular data manipulation
library(tidyverse)
library(data.table)

# microbiome specific packages
library(maaslin3)
library(mia)
# some packages for data visualization (plots and tables)
library(miaViz)
library(pheatmap)
library(UpSetR)
library(ggpubr)
library(kableExtra)
library(reactable)

# MAC's package to download data
library(parkinsonsMetagenomicData) # devtools::install_github("ASAP-MAC/parkinsonsMetagenomicData")
library(biobakeryUtils) # devtools::install_github("g-antonello/biobakeryUtils")
library(ggh4x) # for complex ggplot2 faceting
# set ggplot2 plot themes 
theme_set(theme_light())
# set seed for reproducibility
set.seed(1234)
```

# Create output directories all in one chunk

```{r}

output_directories.list <- list(
  # alpha diversity directory
  alpha_div_outdir = file.path(params$basic_outdir, params$humann_data_type, "01_alpha_diversity"),
  # beta diversity output directory
  beta_div_outdir = file.path(params$basic_outdir, params$humann_data_type, "02_beta_diversity")
)

tmp_out <- capture.output(sapply(output_directories.list, dir.create, showWarnings = FALSE, recursive = TRUE))
rm(tmp_out)
```

# Load data for analysis

```{r}
InputHumannData.tse <- read_TSE_from_dir("Data/HUMAnN_pathways_unstratified.tse")
InputHumannData.tse
```

# The vast majority of reads do not map to a pathway

These features will be removed, because they are crushing the remaining pathways

```{r, fig.height = 8, fig.width=12, fig.cap="Stack plot of the top 30 most abundant pathways, with highlight on the distribution of UNMAPPED and UNINTEGRATED reads."}
topN_pwys <- getTop(InputHumannData.tse, 20, assay.type = "gene_family_abundance_rpk_relab_unstratified")
colors_top2 <- rev(scater:::.get_palette(palette_name = "tableau10medium"))[1:2]
stackplot_top_N <- InputHumannData.tse[topN_pwys, ] %>% 
  miaViz::plotAbundance(assay.type = "gene_family_abundance_rpk_relab_unstratified") + 
  theme(legend.position = "bottom")

hist_unmapped <- ggplot(data.frame(UNMAPPED = assay(InputHumannData.tse, "gene_family_abundance_rpk_relab_unstratified")["UNMAPPED", ]), aes(x = UNMAPPED)) + 
  geom_histogram(binwidth = 0.01, fill = colors_top2[1], alpha = 0.65)

hist_unintegrated <- ggplot(data.frame(UNINTEGRATED = assay(InputHumannData.tse, "gene_family_abundance_rpk_relab_unstratified")["UNINTEGRATED", ]), aes(x = UNINTEGRATED)) + 
  geom_histogram(binwidth = 0.01,  fill = colors_top2[2], alpha = 0.65)

ggarrange(stackplot_top_N, ggarrange(hist_unmapped, hist_unintegrated, nrow = 1, ncol = 2), nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")
```

## UNMAPPED and UNINTEGRATED reads vary with Microbiome

```{r}

stats_unintegr_unmapp <- meltSE(InputHumannData.tse, assay.type = "gene_family_abundance_rpk_relab_unstratified", add.col = c("sex", "donor_microbiome_type")) %>% 
  filter(grepl("^UN", FeatureID)) %>% 
  group_by(FeatureID) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~broom::tidy(lm(gene_family_abundance_rpk_relab_unstratified ~ sex + donor_microbiome_type, data = .x)))
  ) %>% 
  unnest(model)

plot_unintegr_unmapp <- meltSE(InputHumannData.tse, assay.type = "gene_family_abundance_rpk_relab_unstratified", add.col = c("sex", "donor_microbiome_type")) %>% 
  filter(grepl("^UN", FeatureID)) %>% 
  ggplot(aes(x = sex, y = gene_family_abundance_rpk_relab_unstratified, color = donor_microbiome_type)) + 
  geom_boxplot(width = 0.3) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2, seed = 1234)) +
  facet_wrap(~FeatureID) + 
  labs(
    color = "Donor Microbiome"
  ) + 
  theme_bw() + 
  theme(legend.position = "top")
```

```{r}
plot_unintegr_unmapp
```

```{r}
stats_unintegr_unmapp %>% 
  select(-data) %>% 
  filter(grepl("donor_microbiome_type", term)) %>% 
  kbl() %>% 
  kable_styling()
```


```
UNMAPPED: Reads did not map to any gene/gene family
UNINTEGRATED: Reads did map into a gene-gene family, BUT but that gene/gene family was not in the pathways database
```

Fractions of Unmapped and Unintegrated reads have opposite trends because if 
one sample has a higher fraction of unmapped reads, it will necessarily 
have a smaller fraction of unintegrated and correctly mapped ones. Vice versa,
if the unintegrated fraction is higher, unmapped reads will have to be less.

```{r}
InputHumannData.tse[grepl("^UN", rownames(InputHumannData.tse)),] %>% 
  assay("gene_family_abundance_rpk_relab_unstratified") %>%
  t() %>% 
  cor()
```

Conclusion: Wild mice have a tendency to have more 2% less unmapped reads and 2%
more unintegrated reads among the mapped ones. This or more unmapped reads.
As a consequence, among the known genes and pathways they have less unintegrated
gene families. This confirms that 
**WildR mice microbiomes are less characterized and isolated**

## WildR mice have more pathways per sample mapped than SPF

```{r}
alpha_indices <- c("dbp_dominance", "gini", "observed_richness", "shannon_diversity")
InputHumannData.tse <- addAlpha(InputHumannData.tse, assay.type = "gene_family_abundance_rpk_relab_unstratified", index = alpha_indices)

tmp <- sapply(alpha_indices, function(div) {
  lm(as.formula(paste(div, "~", "sex + donor_microbiome_type")), data = colData(InputHumannData.tse))
  
}, USE.NAMES = TRUE, simplify = FALSE)

table_results.df <- tmp %>% lapply(broom::tidy) %>% 
  bind_rows(.id = "AlphaIndex") %>% 
  filter(!grepl("Intercept", term))

table_results.df %>%
  kbl() %>% 
  row_spec(which(table_results.df$p.value < 0.05), bold = TRUE) %>% 
  kable_styling()
```

WildR microbiomes show more pathways and minimally more evenly distributed 
abundances of such pathways.

# Compositional differences in relation to the donor microbiome

```{r}
dimRedName <- paste(params$beta_dist, "mds", sep = "_")
# this will work once mia or TreeSummarizedExperiment fixes some things
InputHumannData.tse <- mia::addMDS(
  InputHumannData.tse,
  assay.type = "gene_family_abundance_rpk_relab_unstratified",
  method = params$beta_dist,
  ncomponents = 3, name = dimRedName
  )

variances_explained <- attr(reducedDim(InputHumannData.tse, dimRedName), "eig")
prop_variances_explained <- variances_explained/sum(variances_explained)

mds_data_for_plot.df <- cbind.data.frame(as.data.frame(colData(InputHumannData.tse)), reducedDim(InputHumannData.tse, dimRedName) %>% as.data.frame() %>% set_names(paste("MDS", 1:ncol(.))))

beta_plot_all_features <- mds_data_for_plot.df %>% 
  ggplot(aes(x = `MDS 1`, y = `MDS 2`, color = paste(donor_microbiome_type, sex))) + 
  geom_point(size = 2) + 
  stat_ellipse(show.legend = FALSE) + 
  #scale_color_manual(values = ggsci::pal_jco()(6)) +
  theme(legend.position = "top") +
  labs(color = "Sex and Microbiome",
       x = paste0("MDS 1 [", round(prop_variances_explained[1]*100, 1), "%]"),
       y = paste0("MDS 2 [", round(prop_variances_explained[2]*100, 2), "%]")
  )

```

```{r}
dimRedName <- paste(params$beta_dist, "mds", "no_UN.", sep = "_")
# this will work once mia or TreeSummarizedExperiment fixes some things
InputHumannData.tse <- mia::addMDS(
  InputHumannData.tse[!startsWith(rownames(InputHumannData.tse), "UN"),],
  assay.type = "gene_family_abundance_rpk_relab_unstratified",
  method = params$beta_dist,
  ncomponents = 3, name = dimRedName
  )

variances_explained <- attr(reducedDim(InputHumannData.tse, dimRedName), "eig")
prop_variances_explained <- variances_explained/sum(variances_explained)

mds_data_for_plot.df <- cbind.data.frame(as.data.frame(colData(InputHumannData.tse)), reducedDim(InputHumannData.tse, dimRedName) %>% as.data.frame() %>% set_names(paste("MDS", 1:ncol(.))))

beta_plot_no_UNINT_UNMAP <- mds_data_for_plot.df %>% 
  ggplot(aes(x = `MDS 1`, y = `MDS 2`, color = paste(donor_microbiome_type, sex))) + 
  geom_point(size = 2) + 
  stat_ellipse(show.legend = FALSE) + 
  #scale_color_manual(values = ggsci::pal_jco()(6)) +
  theme(legend.position = "top") +
  labs(color = "Sex and Microbiome",
       x = paste0("MDS 1 [", round(prop_variances_explained[1]*100, 1), "%]"),
       y = paste0("MDS 2 [", round(prop_variances_explained[2]*100, 2), "%]")
  )

```

```{r}
ggsave(plot = beta_plot_all_features, filename = file.path(output_directories.list$beta_div_outdir, "bray_MDS_plot_all_features.png"), dpi = 600, height = 7.5, width = 6)
ggsave(plot = beta_plot_no_UNINT_UNMAP, filename = file.path(output_directories.list$beta_div_outdir, "bray_MDS_plot_no_UNMAP_UNINT.png"), dpi = 600, height = 7.5, width = 6)

ggarrange(beta_plot_all_features + labs(title = "All Features"),
          beta_plot_no_UNINT_UNMAP + labs(title = "All except UNINTEGR. and UNMAPP."),
          common.legend = TRUE)
```

## PERMANOVA statistics

```{r}

InputHumannData.tse <- addPERMANOVA(
  InputHumannData.tse,
  assay.type = "gene_family_abundance_rpk_relab_unstratified",
  method = "bray",
  formula = x ~ sex + donor_microbiome_type,
  name = "permanova",
  permutations = 999,
  test.homogeneity = TRUE
)

permanova_table.df <- PERMANOVA_to_table(InputHumannData.tse)

write_tsv(permanova_table.df, file = file.path(output_directories.list$beta_div_outdir, paste(params$beta_dist, "adonisPermanova", "sex", "donor_microbiome_type.tsv", sep = "_")))
```

```{r}
permanova_table.df %>% 
  kbl() %>% 
  kable_styling()
```

## Unsupervised heatmap of all pathways show 4 WildR mice with SPF-like microbiomes

And they do not belong to one specific cage

```{r, fig.height=8, fig.width=10}
pheatmap::pheatmap(assay(InputHumannData.tse, "gene_family_abundance_rpk_relab_unstratified") %>% magrittr::set_colnames(colData(InputHumannData.tse)$sample_name), scale = "row", annotation_col = colData(InputHumannData.tse) %>% as.data.frame() %>%  magrittr::set_rownames(.$sample_name) %>% select(sex, donor_microbiome_type, cage), angle_col = 315, show_rownames = FALSE)
```

# Differentially abundant pathways in `WildR` mice compared to SPF

$$
\log_2(Pathway) \sim sex + \text{donor_microbiome_type}
$$

```{r}
# prepare input data

tmp.tse <- InputHumannData.tse
tmp.tse <- tmp.tse[rowSums(assay(tmp.tse)) > 0 , ]
tmp.tse

# define experiment name and output directories
maaslin3_expmt <- "WildR_vs_SPD_adj_sex"
maaslin3_final_outdir <- file.path(params$basic_outdir, params$humann_data_type, maaslin3_expmt)
# create definitive output directory
dir.create(maaslin3_final_outdir, showWarnings = FALSE, recursive = TRUE)
```

Results are stored in ``r maaslin3_final_outdir``

```{r}
set.seed(1234)
pathway_differences_in_WildR_mice.maaslin3 <- maaslin3(
    input_data = tmp.tse,
    formula = ~ sex + donor_microbiome_type, 
    transform = "LOG", 
    normalization = "TSS",
    output = maaslin3_final_outdir,
    # do not standardize continuous metadata variables in the model
    standardize = FALSE,
    plot_associations = FALSE,
    save_plots_rds = TRUE,
    verbosity = "ERROR"
  )

# add taxonomy
pathway_differences_in_WildR_mice.maaslin3_curated <- list(
  "prevalence" = pathway_differences_in_WildR_mice.maaslin3$fit_data_prevalence$results,
  "abundance" = pathway_differences_in_WildR_mice.maaslin3$fit_data_abundance$results
  )

# write tables
write_maaslin3_curated_tables(pathway_differences_in_WildR_mice.maaslin3_curated, out.dir = maaslin3_final_outdir)
# save raw output
saveRDS(pathway_differences_in_WildR_mice.maaslin3, file = file.path(maaslin3_final_outdir, "maaslin3_raw_output.rds"))
```


```{r, fig.height=10, fig.width=16}
readRDS(file.path(maaslin3_final_outdir, "figures", "summary_plot_gg.RDS"))
```

## Differentially prevalent pathways

### P-value and FDR histograms

```{r, fig.width=8, fig.height=5}
pval_histogram <- pathway_differences_in_WildR_mice.maaslin3_curated$prevalence %>% 
  filter(
    value == "WildR"
    ) %>% 
  ggplot(aes(x = pval_individual)) + 
  geom_histogram() +
  labs(
    title = "P-value (individual)"
  )

FDR_histogram <- pathway_differences_in_WildR_mice.maaslin3_curated$prevalence %>% 
  filter(
    value == "WildR"
  ) %>% 
  ggplot(aes(x = qval_individual)) + 
  geom_histogram() +
  labs(
    title = "FDR (individual)"
    )

ggarrange(pval_histogram, FDR_histogram)
```

### Table of FDR < 0.1 prevalence associations

```{r}
pathway_differences_in_WildR_mice.maaslin3_curated$prevalence %>% 
  filter(qval_individual < 0.1, is.na(error), value == "WildR") %>% 
  arrange(desc(abs(coef))) %>% 
  select(-metadata, -value) %>% 
  DT::datatable(
     extensions = "Buttons",
    options = list(dom = "Bfrtip",
                   buttons = c('copy', 'csv', 'excel', 'pdf'))
  )
```

## Differentially abundant pathways

### P-value and FDR histograms

```{r, fig.width=8, fig.height=5}
pval_histogram <- pathway_differences_in_WildR_mice.maaslin3_curated$abundance %>% filter(
  value == "WildR"
) %>% 
  ggplot(aes(x = pval_individual)) + 
  geom_histogram() +
  labs(
    title = "P-value (individual)"
  )

FDR_histogram <- pathway_differences_in_WildR_mice.maaslin3_curated$abundance %>% filter(
  value == "WildR"
) %>% 
  ggplot(aes(x = qval_individual)) + 
  geom_histogram() +
  labs(
    title = "FDR (individual)"
    )

ggarrange(pval_histogram, FDR_histogram)
```

### Table of FDR < 0.1 abundance associations

```{r}
pathway_differences_in_WildR_mice.maaslin3_curated$abundance %>% 
  filter(qval_individual < 0.1, is.na(error), value == "WildR") %>% 
  arrange(desc(abs(coef))) %>% 
  select(-metadata, -value) %>% 
  DT::datatable(
     extensions = "Buttons",
    options = list(dom = "Bfrtip",
                   buttons = c('copy', 'csv', 'excel', 'pdf'))
  )
```

As it often happens with pathway analyses, there are MANY statistical 
associations.


# Pathways table per microbiome type

```{r}
InputHumannData.tse %>% 
  meltSE(assay.type = "pathway_abundance_unstratified", add.col = c("donor_microbiome_type")) %>% 
  group_by(FeatureID, donor_microbiome_type) %>% 
  reframe(
    N = n(),
    N_not_0 = sum(pathway_abundance_unstratified > 0),
    mean_abund = mean(pathway_abundance_unstratified)
  ) %>% 
  pivot_wider(names_from = "donor_microbiome_type", values_from = c("N", "N_not_0", "mean_abund")) %>% 
  DT::datatable(
     extensions = "Buttons",
    options = list(dom = "Bfrtip",
                   buttons = c('copy', 'csv', 'excel', 'pdf'))
  )
```

# Session Info

```{r}
sessionInfo()
```

